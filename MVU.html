
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        const e = Vue,
            t = { id: "app", class: "status-card" },
            a = { class: "tabs" },
            l = { class: "tab-container" },
            _get = (obj, path, def) => {
                const keys = path.split('.');
                let res = obj;
                for (const key of keys) {
                    if (res == null) return def;
                    res = res[key];
                }
                return res === undefined ? def : res;
            };

        const qt = (0, e.defineComponent)({
            setup() {
                const activeTab = (0, e.ref)("Page1"),
                    data = (0, e.ref)({}),
                    expanded = (0, e.reactive)({ exp: !0, outfit: !1, bodyMods: !1, titles: !1 });

                const toggle = (k) => { expanded[k] = !expanded[k] };
                const isExp = (k) => !!expanded[k];
                const parseBool = (v, d = !1) => v == null ? d : (typeof v === 'boolean' ? v : String(v).toLowerCase() === 'true');
                const toArr = (o) => (o && typeof o === 'object') ? Object.entries(o).filter(([k]) => k !== '$meta') : [];
                const fmtObj = (o, t = "无") => {
                    const a = toArr(o);
                    return a.length ? a.map(([k, v]) => `${k}: ${v}`).join("； ") : t;
                };
                const fmtDet = (o) => {
                    const a = toArr(o);
                    return a.length ? a.map(([k, v]) => v ? `${k}: ${v}` : k).filter(Boolean).join("； ") : "无";
                };
                const fmtUnlock = (v, p = "", s = "") => (v === -1 || v === false || v == null) ? { text: "未解锁", className: "locked-value" } : (v === true ? { text: "已解锁", className: "" } : { text: `${p}${v}${s}`, className: "" });
                const fmtCur = (v) => {
                    if (v == null || v === "") return "￥ 0";
                    return typeof v === 'number' ? `￥ ${v}` : `￥ ${String(v).trim() || '0'}`;
                };

                const load = async () => {
                    try {
                        if (typeof getChatMessages === 'function') {
                            const msgs = await getChatMessages(getCurrentMessageId());
                            if (msgs?.[0]?.data?.stat_data) data.value = msgs[0].data.stat_data;
                        }
                    } catch (err) { console.error(err); }
                };

                (0, e.onMounted)(async () => {
                    const s = localStorage.getItem("momo_status:active_tab");
                    if (s) activeTab.value = s;
                    await load();
                    if (typeof eventOn === 'function') eventOn('variable_update_ended', load);
                });

                (0, e.watch)(activeTab, (v) => localStorage.setItem("momo_status:active_tab", v));

                // Computed Properties from File 1
                const world = (0, e.computed)(() => ({
                    loc: String(_get(data.value, "世界.地点", "未知")),
                    wea: String(_get(data.value, "世界.天气", "晴朗")),
                    date: `${_get(data.value, "世界.日期.年", "YYYY")}年${String(_get(data.value, "世界.日期.月", "MM")).padStart(2, '0')}月${String(_get(data.value, "世界.日期.日", "DD")).padStart(2, '0')}日`,
                    time: `${String(_get(data.value, "世界.时间.小时", "00")).padStart(2, '0')}:${String(_get(data.value, "世界.时间.分钟", "00")).padStart(2, '0')}`,
                    week: { 1: "星期一", 2: "星期二", 3: "星期三", 4: "星期四", 5: "星期五", 6: "星期六", 7: "星期日" }[String(_get(data.value, "世界.星期"))] || "未知"
                }));

                const core = (0, e.computed)(() => ({
                    money: fmtCur(_get(data.value, "墨墨.常规物品.金钱", 0)),
                    credits: String(_get(data.value, "墨墨.常规物品.学分", 0)),
                    exp: String(_get(data.value, "墨墨.身份暴露度", 0)),
                    sta: String(_get(data.value, "墨墨.身处状态", "未知")),
                    sat: String(_get(data.value, "发布者.发布者满意度", 0)),
                    count: `${_get(data.value, "发布者.任务发放倒计时天数", 0)} 天`,
                    inPen: parseBool(_get(data.value, "发布者.惩罚中", false)),
                    penInfo: fmtObj(_get(data.value, "发布者.惩罚措施", {}), "查看详情")
                }));

                const bodyMods = (0, e.computed)(() => [
                    { k: "穿孔", l: "穿孔位置", p: "墨墨.身体改造.穿孔位置" },
                    { k: "纹身", l: "纹身", p: "墨墨.身体改造.纹身" },
                    { k: "器官", l: "器官改造", p: "墨墨.身体改造.器官改造" }
                ].map(c => ({ label: c.l, items: toArr(_get(data.value, c.p, {})).map(([k, v]) => ({ n: k, d: String(v) })), ek: `bm:${c.k}` })));

                const outfit = (0, e.computed)(() => ({
                    top: fmtDet(_get(data.value, "墨墨.服装状态.上装", {})),
                    bot: fmtDet(_get(data.value, "墨墨.服装状态.下装", {})),
                    suit: fmtDet(_get(data.value, "墨墨.服装状态.套装", {})),
                    bra: fmtDet(_get(data.value, "墨墨.服装状态.内衣", {})),
                    pan: fmtDet(_get(data.value, "墨墨.服装状态.内裤", {})),
                    sock: fmtDet(_get(data.value, "墨墨.服装状态.袜子", {})),
                    shoe: fmtDet(_get(data.value, "墨墨.服装状态.鞋子", {})),
                    acc: fmtDet(_get(data.value, "墨墨.服装状态.饰品", {})),
                    hand: fmtDet(_get(data.value, "墨墨.服装状态.手持物品", {})),
                    pier: fmtDet(_get(data.value, "墨墨.服装状态.穿孔道具", {})),
                    toy: fmtDet(_get(data.value, "墨墨.服装状态.性玩具", {})),
                    spec: fmtDet(_get(data.value, "墨墨.服装状态.特殊分类", {}))
                }));

                const sex = (0, e.computed)(() => ({
                    dep: String(_get(data.value, "墨墨.色情状态.堕落值", 0)),
                    depl: String(_get(data.value, "墨墨.色情状态.堕落等级", 0)),
                    lust: String(_get(data.value, "墨墨.色情状态.性欲", 0)),
                    expos: String(_get(data.value, "墨墨.色情状态.暴露值", 0)),
                    womb: `${_get(data.value, "墨墨.色情状态.宫内精液", 0)}ml`,
                    anal: `${_get(data.value, "墨墨.色情状态.肛门精液", 0)}ml`,
                    jui: `${_get(data.value, "墨墨.色情状态.淫水数量", 0)}ml`,
                    ext: toArr(_get(data.value, "墨墨.色情状态.外部精液", {})).map(([k, v]) => ({ k, v: v ?? 0 }))
                }));

                const records = (0, e.computed)(() => ({
                    exp: `次数: ${_get(data.value, "墨墨.身体色情记录.性经验", 0)}`,
                    org: String(_get(data.value, "墨墨.身体色情记录.高潮次数", 0)),
                    vV: parseBool(_get(data.value, "墨墨.身体色情记录.阴道处女", true), true),
                    vA: parseBool(_get(data.value, "墨墨.身体色情记录.肛门处女", true), true),
                    dM: String(_get(data.value, "墨墨.身体色情记录.口穴开发度", 0)),
                    dP: String(_get(data.value, "墨墨.身体色情记录.私处开发度", 0)),
                    dA: String(_get(data.value, "墨墨.身体色情记录.肛门开发度", 0)),
                    dB: String(_get(data.value, "墨墨.身体色情记录.乳房开发度", 0)),
                    sB: String(_get(data.value, "墨墨.身体色情记录.屁股敏感度", 0))
                }));

                const wardrobe = (0, e.computed)(() => [
                    "上装", "下装", "套装", "内衣", "内裤", "袜子", "鞋子", "饰品", "手持物品", "穿孔道具", "性玩具", "特殊分类"
                ].map(k => ({
                    label: k,
                    items: toArr(_get(data.value, `墨墨.衣柜.${k}`, {})).map(([n, v]) => ({ n, d: String(v).split("(基础暴露值")[0].trim() })),
                    ek: `wd:${k}`
                })));

                const assets = (0, e.computed)(() => [
                    { k: "载具", l: "载具" }, { k: "房产", l: "房产" }
                ].map(c => ({ label: c.l, items: toArr(_get(data.value, `墨墨.资产.${c.k}`, {})).map(([n, v]) => ({ n, d: String(v) })), ek: `as:${c.k}` })));

                const tasks = (0, e.computed)(() => {
                    const tks = _get(data.value, "任务", {});
                    return Object.entries(tks).filter(([k]) => k !== '$meta' && k !== 'template').map(([n, d]) => ({
                        name: n,
                        status: String(d.任务状态 || "未知"),
                        sc: { '未开始': 'not-started', '已接受': 'in-progress', '进行中': 'in-progress', '已完成': 'completed', '已失败': 'failed' }[d.任务状态] || '',
                        fields: [
                            { k: "类型", v: d.任务类型 }, { k: "地点", v: d.任务地点 }, { k: "目标", v: d.基础任务目标 },
                            { k: "标准", v: fmtObj(d.基础任务完成标准) }, { k: "进度", v: d.任务进度 },
                            { k: "截止", v: d.任务结束时间 }, { k: "报酬", v: fmtCur(d.任务基础报酬) }
                        ].filter(f => f.v && f.v !== "无"),
                        ev: toArr(d.当前任务已保存证据 || {}).map(([k, v]) => ({ k, v: String(v) })),
                        ek: `tk:${n}`
                    }));
                });

                const titles = (0, e.computed)(() => ({
                    toy: fmtUnlock(_get(data.value, "墨墨.称号.经济学教授的玩物", -1), "好感度: "),
                    bAss: fmtUnlock(_get(data.value, "墨墨.称号.篮球部助理", -1), "进度: "),
                    bSat: String(_get(data.value, "墨墨.称号.篮球部成员满意度", 0)),
                    bDay: parseBool(_get(data.value, "墨墨.称号.篮球部日常任务", false)),
                    sAss: fmtUnlock(_get(data.value, "墨墨.称号.游泳部助理", -1), "进度: "),
                    sSat: String(_get(data.value, "墨墨.称号.游泳社成员满意度", 0)),
                    sDay: parseBool(_get(data.value, "墨墨.称号.游泳社日常任务", false)),
                    surv: fmtUnlock(_get(data.value, "墨墨.称号.遗主者", -1), "进度: "),
                    survM: parseBool(_get(data.value, "墨墨.称号.遗主者任务", false)),
                    scour: fmtUnlock(_get(data.value, "墨墨.称号.天灾", -1), "进度: ")
                }));

                const evals = (0, e.computed)(() => [
                    { k: "同学评价", v: String(_get(data.value, "墨墨.外部评价.同学评价", "暂无")) },
                    { k: "老师评价", v: String(_get(data.value, "墨墨.外部评价.老师评价", "暂无")) },
                    { k: "暗网评价", v: String(_get(data.value, "墨墨.外部评价.暗网评价", "暂无")) },
                    { k: "互联网评价", v: String(_get(data.value, "墨墨.外部评价.互联网评价", "暂无")) }
                ]);

                return {
                    activeTab, toggle, isExp, data,
                    world, core, bodyMods, outfit, sex, records, wardrobe, assets, tasks, titles, evals,
                    inv: (0, e.computed)(() => toArr(_get(data.value, "墨墨.背包.物品", {})).map(([k, v]) => ({ k, v: v ?? 0 }))),
                    memos: (0, e.computed)(() => toArr(_get(data.value, "墨墨.备忘录", {})).map(([k, v]) => ({ k, v: String(v) }))),
                    expL: (0, e.computed)(() => toArr(_get(data.value, "墨墨.任务经验", {})).map(([k, v]) => ({ k: k.replace("任务经验", ""), v: v ?? 0 })))
                };
            }
        }).mount("#app");
    </script>
    <style>
        @import url(https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap);
        :root {
            --bg-color: transparent; --card-bg-color: rgba(255, 248, 250, 0.95);
            --border-color: rgba(255, 192, 203, 0.5); --text-primary-color: #8b576e;
            --text-secondary-color: #b48a9d; --accent-color: #f472b6;
            --accent-soft: rgba(244, 114, 182, 0.15); --tab-bg-color: rgba(255, 240, 244, 0.9);
            --item-bg-color: rgba(255, 255, 255, 0.65); --item-border-color: rgba(255, 192, 203, 0.4);
            --item-hover-bg-color: rgba(244, 114, 182, 0.1); --boolean-true-color: #6ee7b7;
            --boolean-false-color: #f78b8b; --locked-color: #d1d5db; --warning-color: #ef4444;
        }
        body { font-family: "Noto Sans SC", sans-serif; background-color: var(--bg-color); color: var(--text-primary-color); margin: 0; padding: 0; }
        .status-card { width: 100%; height: 100%; background-color: var(--card-bg-color); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); font-size: 14px; display: flex; flex-direction: column; }
        .tabs { display: flex; background-color: var(--tab-bg-color); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .tab-button { flex-grow: 1; padding: 12px 10px; cursor: pointer; border: none; background-color: transparent; color: var(--text-secondary-color); font-size: 0.95em; font-weight: 500; transition: all 0.3s ease; position: relative; outline: none; }
        .tab-button.active { color: var(--text-primary-color); font-weight: 700; }
        .tab-button.active:after { content: ""; position: absolute; bottom: 0; left: 20%; width: 60%; height: 2px; background-color: var(--accent-color); }
        .tab-container { flex-grow: 1; overflow-y: auto; padding: 18px; }
        .section { margin-bottom: 22px; }
        .section-header { font-weight: 700; font-size: 1.1em; color: var(--accent-color); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .property-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px; }
        .property-list { display: flex; flex-direction: column; gap: 10px; }
        .property { background-color: var(--item-bg-color); border-radius: 8px; padding: 10px 12px; border: 1px solid var(--item-border-color); display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
        .property:hover { transform: translateY(-2px); background-color: var(--item-hover-bg-color); box-shadow: 0 4px 15px rgba(255, 192, 203, 0.2); }
        .property-name { color: var(--text-secondary-color); font-weight: 500; font-size: 0.9em; flex-shrink: 0; }
        .value-main { font-weight: 500; color: var(--text-primary-color); text-align: right; word-wrap: break-word; }
        .collapsible-header { cursor: pointer; padding: 10px 12px; border-radius: 6px; background-color: var(--item-bg-color); margin-bottom: 2px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .collapsible-header:hover { background-color: var(--accent-soft); }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s; padding-left: 15px; border-left: 2px solid var(--accent-soft); }
        .collapsible-content.expanded { max-height: 200vh; margin-top: 5px; }
        .collapsible-arrow { transition: 0.3s; color: var(--accent-color); font-size: 0.8em; }
        .list-item { display: flex; justify-content: space-between; padding: 8px 6px; border-bottom: 1px solid var(--border-color); }
        .item-desc { color: var(--text-secondary-color); font-size: 0.9em; }
        .boolean-value.is-true { color: var(--boolean-true-color); font-weight: 700; }
        .boolean-value.is-false { color: var(--boolean-false-color); font-weight: 700; }
        .locked-value { color: var(--locked-color); font-style: italic; }
        .task-status { font-weight: 700; }
        .not-started { color: #facc15; } .in-progress { color: #60a5fa; } .completed { color: #6ee7b7; } .failed { color: #f78b8b; }
        .evaluation-item { background-color: var(--item-bg-color); border-radius: 8px; padding: 12px; border: 1px solid var(--item-border-color); margin-bottom: 10px; }
        .evaluation-title { color: var(--text-secondary-color); font-weight: 500; margin-bottom: 4px; }
    </style>
</head>
<body>
    <div id="app" class="status-card">
        <div class="tabs">
            <button v-for="t in [['Page1','状态总览'],['Page2','情欲记录'],['Page3','个人物品'],['Page4','外部讯息']]" :key="t[0]" @click="activeTab=t[0]" :class="['tab-button',{active:activeTab===t[0]}]">{{t[1]}}</button>
        </div>
        <div class="tab-container">
            <!-- Page 1 -->
            <div v-show="activeTab==='Page1'">
                <div class="section">
                    <div class="section-header">世界状态</div>
                    <div class="property-grid">
                        <div class="property"><span class="property-name">地点:</span><span class="value-main">{{world.loc}}</span></div>
                        <div class="property"><span class="property-name">日期:</span><span class="value-main">{{world.date}}</span></div>
                        <div class="property"><span class="property-name">时间:</span><span class="value-main">{{world.time}} ({{world.week}})</span></div>
                        <div class="property"><span class="property-name">天气:</span><span class="value-main">{{world.wea}}</span></div>
                    </div>
                </div>
                <div class="section">
                    <div class="section-header">墨墨 - 核心</div>
                    <div class="property-grid">
                        <div class="property"><span class="property-name">金钱:</span><span class="value-main">{{core.money}}</span></div>
                        <div class="property"><span class="property-name">学分:</span><span class="value-main">{{core.credits}}</span></div>
                        <div class="property"><span class="property-name">暴露度:</span><span class="value-main">{{core.exp}}</span></div>
                        <div class="property"><span class="property-name">满意度:</span><span class="value-main">{{core.sat}}</span></div>
                    </div>
                    <div v-if="core.inPen" class="property" style="margin-top:10px; border-color:var(--warning-color); background:rgba(239,68,68,0.1)">
                        <span class="property-name" style="color:var(--warning-color)">⚠ 惩罚中:</span><span class="value-main">{{core.penInfo}}</span>
                    </div>
                </div>
                <div class="section">
                    <div class="section-header" style="cursor:pointer" @click="toggle('bodyMods')">
                        <span>身体改造</span><span class="collapsible-arrow" :style="{transform:isExp('bodyMods')?'rotate(90deg)':'rotate(0deg)'}">▶</span>
                    </div>
                    <div :class="['collapsible-content',{expanded:isExp('bodyMods')}]" style="border:none; padding:0">
                        <div v-for="c in bodyMods" :key="c.ek">
                            <div class="collapsible-header" @click="toggle(c.ek)"><span>{{c.label}}</span><span>▶</span></div>
                            <div :class="['collapsible-content',{expanded:isExp(c.ek)}]">
                                <div v-for="i in c.items" :key="i.n" class="list-item"><span>{{i.n}}</span><span class="item-desc">{{i.d}}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <div class="section-header" style="cursor:pointer" @click="toggle('outfit')">
                        <span>当前着装</span><span class="collapsible-arrow" :style="{transform:isExp('outfit')?'rotate(90deg)':'rotate(0deg)'}">▶</span>
                    </div>
                    <div :class="['collapsible-content',{expanded:isExp('outfit')}]" style="border:none; padding:0">
                        <div class="property-list">
                            <div v-for="(v,k) in outfit" :key="k" class="property"><span class="property-name">{{k}}:</span><span class="value-main">{{v}}</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Page 2 -->
            <div v-show="activeTab==='Page2'">
                <div class="section">
                    <div class="section-header">色情状态</div>
                    <div class="property-grid">
                        <div class="property"><span class="property-name">堕落:</span><span class="value-main">{{sex.dep}} (Lv.{{sex.depl}})</span></div>
                        <div class="property"><span class="property-name">性欲:</span><span class="value-main">{{sex.lust}}</span></div>
                        <div class="property"><span class="property-name">暴露:</span><span class="value-main">{{sex.expos}}</span></div>
                        <div class="property"><span class="property-name">宫内精液:</span><span class="value-main">{{sex.womb}}</span></div>
                    </div>
                </div>
                <div class="section">
                    <div class="section-header">身体开发记录</div>
                    <div class="property-grid">
                        <div class="property"><span class="property-name">性经验:</span><span class="value-main">{{records.exp}}</span></div>
                        <div class="property"><span class="property-name">阴道处女:</span><span :class="['value-main','boolean-value',records.vV?'is-true':'is-false']">{{records.vV?'是':'否'}}</span></div>
                        <div class="property"><span class="property-name">肛门处女:</span><span :class="['value-main','boolean-value',records.vA?'is-true':'is-false']">{{records.vA?'是':'否'}}</span></div>
                        <div class="property"><span class="property-name">私处开发:</span><span class="value-main">{{records.dP}}</span></div>
                        <div class="property"><span class="property-name">肛门开发:</span><span class="value-main">{{records.dA}}</span></div>
                    </div>
                </div>
            </div>
            <!-- Page 3 -->
            <div v-show="activeTab==='Page3'">
                <div class="section">
                    <div class="section-header">背包物品</div>
                    <div class="property-grid">
                        <div v-for="i in inv" :key="i.k" class="property"><span class="property-name">{{i.k}}</span><span class="value-main">x{{i.v}}</span></div>
                    </div>
                </div>
                <div class="section">
                    <div class="section-header">衣柜 & 资产</div>
                    <div v-for="c in [...wardrobe, ...assets]" :key="c.ek">
                        <div class="collapsible-header" @click="toggle(c.ek)"><span>{{c.label}} ({{c.items.length}})</span><span>▶</span></div>
                        <div :class="['collapsible-content',{expanded:isExp(c.ek)}]">
                            <div v-for="i in c.items" :key="i.n" class="list-item"><span>{{i.n}}</span><span class="item-desc">{{i.d}}</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Page 4 -->
            <div v-show="activeTab==='Page4'">
                <div class="section">
                    <div class="section-header">任务信息</div>
                    <div v-for="t in tasks" :key="t.ek" style="margin-bottom:10px">
                        <div class="collapsible-header" @click="toggle(t.ek)">
                            <span>{{t.name}}</span>
                            <span :class="['task-status',t.sc]">{{t.status}} ▶</span>
                        </div>
                        <div :class="['collapsible-content',{expanded:isExp(t.ek)}]">
                            <div v-for="f in t.fields" :key="f.k" class="property"><span class="property-name">{{f.k}}:</span><span class="value-main">{{f.v}}</span></div>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <div class="section-header" @click="toggle('titles')">持有称号 <span>▶</span></div>
                    <div :class="['collapsible-content',{expanded:isExp('titles')}]" style="border:none; padding:0">
                        <div class="property-list">
                            <div class="property"><span class="property-name">教授的玩物:</span><span :class="['value-main',titles.toy.className]">{{titles.toy.text}}</span></div>
                            <div class="property"><span class="property-name">遗主者:</span><span :class="['value-main',titles.surv.className]">{{titles.surv.text}}</span></div>
                            <div class="property"><span class="property-name">天灾:</span><span :class="['value-main',titles.scour.className]">{{titles.scour.text}}</span></div>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <div class="section-header">外部评价</div>
                    <div class="evaluation-item" v-for="e in evals" :key="e.k">
                        <div class="evaluation-title">{{e.k}}</div>
                        <div class="evaluation-text" style="font-size:0.95em">{{e.v}}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>